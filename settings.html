<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel | UFTB </title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        :root { --primary: #003366; --primary-dark: #002244; --accent: #f39c12; --light: #f4f7f6; --white: #ffffff; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: var(--light); display: flex; height: 100vh; overflow: hidden; }

        .sidebar { width: 260px; background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 25px; display: flex; flex-direction: column; height: 100vh; position: fixed; z-index: 1; }
        .sidebar-header { text-align: center; margin-bottom: 40px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; }
        .menu-item { display: flex; align-items: center; gap: 15px; padding: 12px 20px; color: rgba(255,255,255,0.8); text-decoration: none; border-radius: 10px; margin-bottom: 8px; transition: 0.3s; font-size: 0.95rem; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.2); color: white; transform: translateX(5px); }
        .mt-auto { margin-top: auto; }

        .main-content { margin-left: 260px; flex: 1; padding: 40px; position: relative; width: calc(100% - 260px); }

        /* LOCK SCREEN */
        #lockScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; transition: 0.5s; }
        .pin-box { background: white; padding: 40px; border-radius: 20px; text-align: center; width: 320px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .pin-input { font-size: 2rem; width: 100%; text-align: center; letter-spacing: 10px; border: 2px solid #eee; border-radius: 10px; margin: 20px 0; padding: 10px; outline: none; color: var(--primary); }
        .pin-input:focus { border-color: var(--accent); }
        .unlock-btn { background: var(--primary); color: white; border: none; padding: 12px; width: 100%; border-radius: 10px; font-size: 1rem; cursor: pointer; transition: 0.3s; }
        .unlock-btn:hover { background: var(--accent); }

        /* ADMIN CONTENT */
        .admin-body { display: none; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .header-title h2 { color: var(--primary); font-size: 2rem; font-weight: 700; }
        .header-title p { color: #7f8c8d; }

        .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 40px; }
        .upload-card { background: white; padding: 40px; border-radius: 20px; text-align: center; border: 2px dashed #ccc; cursor: pointer; transition: 0.3s; }
        .upload-card:hover { border-color: var(--accent); background: #fffcf0; transform: translateY(-5px); box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .icon-box { width: 70px; height: 70px; background: #eef2f7; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; color: var(--primary); font-size: 2rem; }
        
        .status-msg { margin-top: 20px; padding: 15px; border-radius: 10px; background: #d4edda; color: #155724; text-align: center; display: none; }
        .sending-msg { background: #fff3cd; color: #856404; display: none; margin-top: 10px; padding: 10px; border-radius: 10px; text-align: center; }

        .danger-zone { margin-top: 60px; padding-top: 30px; border-top: 2px solid #eee; }
        .reset-btn { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; padding: 12px 25px; border-radius: 50px; cursor: pointer; display: flex; align-items: center; gap: 10px; font-weight: 600; transition: 0.3s; }
        .reset-btn:hover { background: #c62828; color: white; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header">
            <h3>UFTB HUB</h3>
            <p style="font-size: 0.8rem; opacity: 0.7;">Exam Control System</p>
        </div>
        <nav>
            <a href="index.html" class="menu-item"><i class="fas fa-clock"></i> Dashboard</a>
            <a href="schedule.html" class="menu-item"><i class="fas fa-calendar-alt"></i> Exam Schedule</a>
            <a href="invigilators.html" class="menu-item"><i class="fas fa-users"></i> Invigilators</a>
            <a href="settings.html" class="menu-item active"><i class="fas fa-user-shield"></i> Admin Panel</a>
        </nav>
    </aside>

    <div class="main-content">
        <div id="lockScreen">
            <div class="pin-box">
                <i class="fas fa-lock" style="font-size: 3rem; color: var(--primary); margin-bottom: 10px;"></i>
                <h3 style="color: var(--primary);">Admin Access</h3>
                <input type="password" id="pinInput" class="pin-input" maxlength="4" placeholder="••••">
                <button class="unlock-btn" onclick="checkPin()">Unlock Dashboard</button>
                <p id="errorMsg" style="color: red; font-size: 0.8rem; margin-top: 10px; display: none;">Incorrect PIN</p>
            </div>
        </div>

        <div class="admin-body" id="adminPanel">
            <div class="header-title">
                <h2>Control Center</h2>
                <p>Upload data and manage system configurations.</p>
            </div>

            <div class="upload-grid">
                <div class="upload-card" onclick="document.getElementById('scheduleCsv').click()">
                    <div class="icon-box"><i class="fas fa-calendar-check"></i></div>
                    <h3>Upload Exam Routine</h3>
                    <p style="color: #777; font-size: 0.9rem;">Update schedule for students</p>
                    <input type="file" id="scheduleCsv" style="display: none;" accept=".csv">
                </div>

                <div class="upload-card" onclick="document.getElementById('dutyCsv').click()">
                    <div class="icon-box"><i class="fas fa-chalkboard-teacher"></i></div>
                    <h3>Upload Teacher Duties</h3>
                    <p style="color: #777; font-size: 0.9rem;">Auto-generates list & sends emails</p>
                    <input type="file" id="dutyCsv" style="display: none;" accept=".csv">
                </div>
            </div>

            <div id="sendingMsg" class="sending-msg"><i class="fas fa-spinner fa-spin"></i> Sending emails to teachers... Please wait.</div>
            <div id="statusMsg" class="status-msg"></div>

            <div class="danger-zone">
                <h4 style="color: #c62828; margin-bottom: 15px;"><i class="fas fa-exclamation-triangle"></i> System Reset</h4>
                <button class="reset-btn" onclick="factoryReset()"><i class="fas fa-trash-alt"></i> Factory Reset All Data</button>
            </div>
        </div>
    </div>

  <script>
        // ================= CONFIGURATION =================
        
        // 1. FIREBASE CONFIG (আপনার দেওয়া তথ্য অনুযায়ী আপডেট করা হয়েছে)
        const firebaseConfig = {
            apiKey: "AIzaSyAI8WXJNIG4_R44idWxuA3np3PwePNxqX0",
            authDomain: "uftbtime.firebaseapp.com",
            databaseURL: "https://uftbtime-default-rtdb.firebaseio.com",
            projectId: "uftbtime",
            storageBucket: "uftbtime.firebasestorage.app",
            messagingSenderId: "260572635171",
            appId: "1:260572635171:web:efaaadc69069d80297d196",
            measurementId: "G-989NJ37C0F"
        };

        // 2. EMAILJS KEYS (আপনার আগের সেটআপ অনুযায়ী)
        const SERVICE_ID = "service_o2bifs8";      // আপনার Service ID
        const TEMPLATE_ID = "template_tcqot09";    // আপনার Template ID
        const PUBLIC_KEY = "FJuG0-WoDmy3DtVDL";    // আপনার Public Key
        
        // =================================================

        const CORRECT_PIN = "1234"; 

        // Initialize Firebase & EmailJS
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        (function() {
            emailjs.init(PUBLIC_KEY);
            updateStorageStatus(); // Check Cloud Storage on load
        })();

        function checkPin() {
            if(document.getElementById('pinInput').value === CORRECT_PIN) {
                document.getElementById('lockScreen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('lockScreen').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'block';
                }, 500);
            } else {
                document.getElementById('errorMsg').style.display = 'block';
            }
        }

        // --- CLOUD STORAGE CHECKER ---
        function updateStorageStatus() {
            // Check Routine from Firebase
            database.ref('schedule').once('value').then((snapshot) => {
                const data = snapshot.val();
                const count = data ? data.length : 0;
                const card = document.getElementById('scheduleStatus');
                document.getElementById('scheduleCount').innerText = count > 0 ? `${count} Exams Online` : "No Cloud Data";
                if(count > 0) card.classList.add('status-active');
            });

            // Check Duties from Firebase
            database.ref('duties').once('value').then((snapshot) => {
                const data = snapshot.val();
                const count = data ? data.length : 0; // Assuming array structure
                const card = document.getElementById('dutyStatus');
                document.getElementById('dutyCount').innerText = count > 0 ? `${count} Teachers Online` : "No Cloud Data";
                if(count > 0) card.classList.add('status-active');
            });
        }

        // UPLOAD HANDLERS
        document.getElementById('scheduleCsv').addEventListener('change', (e) => processCSV(e, 'schedule'));
        document.getElementById('dutyCsv').addEventListener('change', (e) => processCSV(e, 'duty'));

        let currentData = [];
        let currentType = "";

        function processCSV(e, type) {
            const file = e.target.files[0];
            if(!file) return;
            
            currentType = type;
            const reader = new FileReader();
            reader.onload = function(evt) {
                const rows = evt.target.result.split('\n').map(r => r.trim()).filter(r => r);
                // Simple parsing logic...
                currentData = [];
                for(let i=1; i<rows.length; i++) {
                    const cols = rows[i].split(',');
                    if(cols.length < 4) continue;

                    let obj = {};
                    if(type === 'duty') {
                        // Name, Email, Date, Room, Time
                        obj = {
                            name: cols[0].trim(),
                            email: cols[1].trim(),
                            date: cols[2].trim(),
                            room: cols[3].trim(),
                            time: cols[4].trim()
                        };
                    } else {
                        // Date, Time, Course, Room
                        obj = {
                            date: cols[0].trim(),
                            time: cols[1].trim(),
                            course: cols[2].trim(),
                            room: cols[3].trim()
                        };
                    }
                    currentData.push(obj);
                }
                
                // Show Preview (Simplified for this snippet)
                if(confirm(`Loaded ${currentData.length} records. Upload to Cloud Database now?`)) {
                    saveToCloud();
                }
            };
            reader.readAsText(file);
            e.target.value = ''; 
        }

        // --- SAVE TO FIREBASE ---
        function saveToCloud() {
            const path = currentType === 'duty' ? 'duties' : 'schedule';
            
            database.ref(path).set(currentData, (error) => {
                if (error) {
                    showStatus("❌ Error saving to Cloud!");
                    console.error(error);
                } else {
                    showStatus("✅ Data Live on Cloud!");
                    updateStorageStatus();
                    
                    // If duties uploaded, ask for email
                    if(currentType === 'duty') {
                        if(confirm("Data is Live! Do you want to send emails to teachers now?")) {
                            sendBatchEmails();
                        }
                    }
                }
            });
        }

        // --- EMAIL SENDING ---
        function sendBatchEmails() {
            const sendingEl = document.getElementById('sendingMsg');
            sendingEl.style.display = 'block';
            let count = 0;

            currentData.forEach((row, idx) => {
                if(row.email && row.email.includes('@')) {
                    const params = {
                        to_name: row.name,
                        to_email: row.email,
                        message: `Date: ${row.date}\nTime: ${row.time}\nRoom: ${row.room}`
                    };

                    setTimeout(() => {
                        emailjs.send(SERVICE_ID, TEMPLATE_ID, params)
                            .then(() => console.log(`Email sent to ${row.name}`));
                    }, idx * 600); // 600ms delay to avoid rate limit
                    count++;
                }
            });

            setTimeout(() => {
                sendingEl.style.display = 'none';
                showStatus(`✅ Processed! Emails sending to ${count} teachers.`);
            }, 2000);
        }

        function showStatus(msg) {
            const el = document.getElementById('statusMsg');
            el.innerText = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 4000);
        }

        function factoryReset() {
            if(confirm("WARNING: This will delete ALL cloud data. Are you sure?")) {
                database.ref('/').remove()
                    .then(() => {
                        showStatus("♻️ System Factory Reset Complete");
                        updateStorageStatus();
                    })
                    .catch((error) => showStatus("Error resetting: " + error.message));
            }
        }
    </script>
</body>
</html>