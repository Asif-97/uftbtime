<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Panel | UFTB Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        :root { --primary: #003366; --accent: #f39c12; --light: #f4f7f6; --white: #ffffff; --success: #2ecc71; --danger: #e74c3c; }
        body { font-family: 'Poppins', sans-serif; background: var(--light); display: flex; height: 100vh; overflow: hidden; margin: 0; }

        .sidebar { width: 260px; background: linear-gradient(180deg, var(--primary) 0%, #002244 100%); color: white; padding: 25px; display: flex; flex-direction: column; }
        .menu-item { display: flex; align-items: center; gap: 15px; padding: 12px; color: rgba(255,255,255,0.8); text-decoration: none; margin-bottom: 8px; border-radius: 8px; transition: 0.3s; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.2); color: white; }
        .mt-auto { margin-top: auto; }

        .main-content { flex: 1; padding: 40px; overflow-y: auto; }

        /* Lock Screen */
        #lockScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .pin-box { background: white; padding: 40px; border-radius: 20px; text-align: center; }
        .pin-input { font-size: 2rem; width: 150px; text-align: center; letter-spacing: 10px; border: 2px solid #eee; border-radius: 10px; margin: 20px 0; padding: 10px; color: var(--primary); }
        .unlock-btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }

        /* Admin UI */
        .admin-body { display: none; }
        .upload-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .upload-card { background: white; padding: 30px; border-radius: 15px; text-align: center; border: 2px dashed #ccc; cursor: pointer; transition: 0.3s; }
        .upload-card:hover { border-color: var(--accent); background: #fffdf5; }
        
        /* Status Cards */
        .status-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .status-card { background: white; padding: 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid #ddd; }
        .status-active { border-left-color: var(--success); }
        .status-value { font-size: 1.2rem; font-weight: 700; color: var(--primary); }

        /* Preview Table */
        .preview-section { background: white; padding: 20px; border-radius: 15px; margin-top: 20px; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .table-container { max-height: 400px; overflow-y: auto; margin: 15px 0; }
        table { width: 100%; border-collapse: collapse; }
        th { position: sticky; top: 0; background: #f8f9fa; padding: 12px; text-align: left; font-size: 0.9rem; color: #555; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        
        .edit-input { width: 100%; padding: 5px; border: 1px solid transparent; background: transparent; font-family: inherit; font-size: 0.9rem; }
        .edit-input:focus { border-color: var(--accent); background: #fff; outline: none; border-radius: 4px; }

        /* Action Bar */
        .action-bar { display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid #eee; }
        .btn { padding: 10px 20px; border: none; border-radius: 50px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: 0.3s; color: white; }
        .btn-save { background: var(--success); } .btn-save:hover { background: #27ae60; }
        .btn-mail { background: var(--accent); } .btn-mail:hover { background: #d35400; }
        .btn-cancel { background: #95a5a6; } .btn-cancel:hover { background: #7f8c8d; }

        .status-popup { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 15px 25px; border-radius: 8px; display: none; z-index: 1000; }
        .sending-msg { background: #fff3cd; color: #856404; padding: 10px; border-radius: 8px; text-align: center; margin-top: 10px; display: none; }
        .danger-zone { margin-top: 50px; padding-top: 20px; border-top: 2px solid #eee; }
        .reset-btn { background: #ffebee; color: var(--danger); border: 1px solid #ffcdd2; padding: 10px 20px; border-radius: 50px; cursor: pointer; font-weight: 600; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header">
            <h3>UFTB</h3>
            <p style="font-size: 0.8rem;">Admin Panel</p>
        </div>
        <nav>
            <a href="index.html" class="menu-item"><i class="fas fa-clock"></i> Dashboard</a>
            <a href="schedule.html" class="menu-item"><i class="fas fa-calendar-alt"></i> Exam Schedule</a>
            <a href="invigilators.html" class="menu-item"><i class="fas fa-users"></i> Invigilators</a>
            <a href="settings.html" class="menu-item active"><i class="fas fa-user-shield"></i> Admin Panel</a>
        </nav>
    </aside>

    <div class="main-content">
        <div id="lockScreen">
            <div class="pin-box">
                <h3 style="color: var(--primary);">Admin Access</h3>
                <input type="password" id="pinInput" class="pin-input" maxlength="4" placeholder="****">
                <button class="unlock-btn" onclick="checkPin()">Unlock</button>
                <p id="errorMsg" style="color: red; margin-top: 10px; display: none;">Wrong PIN</p>
            </div>
        </div>

        <div class="admin-body" id="adminPanel">
            <h2>Control Center</h2>
            
            <div class="status-grid">
                <div class="status-card" id="scheduleStatus">
                    <div><small>Exam Routine</small><div class="status-value" id="scheduleCount">Checking...</div></div>
                    <i class="fas fa-cloud" style="color:#ccc"></i>
                </div>
                <div class="status-card" id="dutyStatus">
                    <div><small>Teacher Duties</small><div class="status-value" id="dutyCount">Checking...</div></div>
                    <i class="fas fa-cloud" style="color:#ccc"></i>
                </div>
            </div>

            <div class="upload-grid">
                <div class="upload-card" onclick="document.getElementById('scheduleCsv').click()">
                    <i class="fas fa-calendar-check" style="font-size: 2rem; color: var(--primary);"></i>
                    <h3>Upload Routine</h3>
                    <input type="file" id="scheduleCsv" hidden accept=".csv">
                </div>
                <div class="upload-card" onclick="document.getElementById('dutyCsv').click()">
                    <i class="fas fa-chalkboard-teacher" style="font-size: 2rem; color: var(--primary);"></i>
                    <h3>Upload Duties</h3>
                    <input type="file" id="dutyCsv" hidden accept=".csv">
                </div>
            </div>

            <div id="previewArea" class="preview-section">
                <h3 id="previewTitle" style="color: var(--primary); margin-bottom: 10px;">Data Preview</h3>
                <div class="table-container">
                    <table id="dataTable">
                        <thead id="tableHead"></thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
                <div class="action-bar">
                    <span class="count-badge" id="dataCount">0 Records Found</span>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-cancel" onclick="cancelUpload()">Cancel</button>
                        <button class="btn btn-save" onclick="saveToCloud()"><i class="fas fa-cloud-upload-alt"></i> Save to Cloud</button>
                        <button class="btn btn-mail" id="btnEmail" style="display:none;" onclick="sendBatchEmails()"><i class="fas fa-paper-plane"></i> Send Emails</button>
                    </div>
                </div>
            </div>

            <div id="sendingMsg" class="sending-msg"><i class="fas fa-spinner fa-spin"></i> Sending emails... Please wait.</div>
            <div class="danger-zone">
                <h4 style="color: var(--danger); margin-bottom: 15px;">System Reset</h4>
                <button class="reset-btn" onclick="factoryReset()"><i class="fas fa-trash-alt"></i> Factory Reset All Cloud Data</button>
            </div>
        </div>
    </div>

    <div id="toast" class="status-popup"></div>

    <script>
        // ================= CONFIGURATION =================
        const firebaseConfig = {
            apiKey: "AIzaSyAI8WXJNIG4_R44idWxuA3np3PwePNxqX0",
            authDomain: "uftbtime.firebaseapp.com",
            databaseURL: "https://uftbtime-default-rtdb.firebaseio.com",
            projectId: "uftbtime",
            storageBucket: "uftbtime.firebasestorage.app",
            messagingSenderId: "260572635171",
            appId: "1:260572635171:web:efaaadc69069d80297d196",
            measurementId: "G-989NJ37C0F"
        };

        const SERVICE_ID = "service_o2bifs8";
        const TEMPLATE_ID = "template_tcqot09";
        const PUBLIC_KEY = "FJuG0-WoDmy3DtVDL";
        const CORRECT_PIN = "5555"; 
        // =================================================

        // Initialize Firebase & EmailJS
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        (function() {
            emailjs.init(PUBLIC_KEY);
            updateStorageStatus();
        })();

        function checkPin() {
            if(document.getElementById('pinInput').value === CORRECT_PIN) {
                document.getElementById('lockScreen').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('lockScreen').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'block';
                }, 500);
            } else {
                document.getElementById('errorMsg').style.display = 'block';
            }
        }

        function updateStorageStatus() {
            database.ref('schedule').once('value').then((s) => {
                const c = s.val() ? s.val().length : 0;
                document.getElementById('scheduleCount').innerText = c > 0 ? `${c} Exams Online` : "No Data";
                if(c > 0) document.getElementById('scheduleStatus').classList.add('status-active');
            });
            database.ref('duties').once('value').then((s) => {
                const c = s.val() ? s.val().length : 0;
                document.getElementById('dutyCount').innerText = c > 0 ? `${c} Teachers Online` : "No Data";
                if(c > 0) document.getElementById('dutyStatus').classList.add('status-active');
            });
        }

        // UPLOAD LOGIC
        let currentData = [];
        let currentType = ""; 

        document.getElementById('scheduleCsv').addEventListener('change', (e) => processCSV(e, 'schedule'));
        document.getElementById('dutyCsv').addEventListener('change', (e) => processCSV(e, 'duty'));

        function processCSV(e, type) {
            const file = e.target.files[0];
            if(!file) return;
            currentType = type;
            
            const reader = new FileReader();
            reader.onload = function(evt) {
                const rows = evt.target.result.split('\n').map(r => r.trim()).filter(r => r);
                currentData = [];
                
                for(let i=1; i<rows.length; i++) {
                    const cols = rows[i].split(',');
                    if(cols.length < 4) continue;
                    let obj = {};
                    if(type === 'duty') {
                        obj = { name: cols[0], email: cols[1], date: cols[2], room: cols[3], time: cols[4] };
                    } else {
                        obj = { date: cols[0], time: cols[1], course: cols[2], room: cols[3] };
                    }
                    currentData.push(obj);
                }
                renderPreview();
            };
            reader.readAsText(file);
            e.target.value = ''; 
        }

        function renderPreview() {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            const btnEmail = document.getElementById('btnEmail');
            
            document.getElementById('previewArea').style.display = 'block';
            document.getElementById('dataCount').innerText = `${currentData.length} Records Found`;

            let headers = currentType === 'duty' 
                ? '<th>Name</th><th>Email</th><th>Date</th><th>Room</th><th>Time</th>'
                : '<th>Date</th><th>Time</th><th>Course</th><th>Room</th>';
            
            thead.innerHTML = `<tr>${headers}</tr>`;
            btnEmail.style.display = currentType === 'duty' ? 'inline-flex' : 'none';

            tbody.innerHTML = '';
            currentData.forEach((row, idx) => {
                let tr = `<tr>`;
                if(currentType === 'duty') {
                    tr += `<td><input class="edit-input" value="${row.name}" onchange="updateData(${idx}, 'name', this.value)"></td>
                           <td><input class="edit-input" value="${row.email}" onchange="updateData(${idx}, 'email', this.value)"></td>
                           <td>${row.date}</td><td>${row.room}</td><td>${row.time}</td>`;
                } else {
                    tr += `<td>${row.date}</td><td>${row.time}</td><td>${row.course}</td><td>${row.room}</td>`;
                }
                tr += `</tr>`;
                tbody.innerHTML += tr;
            });
        }

        function updateData(idx, field, val) { currentData[idx][field] = val; }
        function cancelUpload() { document.getElementById('previewArea').style.display = 'none'; currentData = []; }

        function saveToCloud() {
            const path = currentType === 'duty' ? 'duties' : 'schedule';
            database.ref(path).set(currentData, (error) => {
                if (error) showStatus("❌ Error saving to Cloud!");
                else {
                    showStatus("✅ Data Live on Cloud!");
                    updateStorageStatus();
                    if(currentType === 'duty' && confirm("Send emails to teachers now?")) sendBatchEmails();
                }
            });
        }

        function sendBatchEmails() {
            const el = document.getElementById('sendingMsg');
            el.style.display = 'block';
            let count = 0;

            currentData.forEach((row, idx) => {
                if(row.email && row.email.includes('@')) {
                    const params = {
                        to_name: row.name,
                        to_email: row.email,
                        message: `Date: ${row.date}\nTime: ${row.time}\nRoom: ${row.room}`
                    };
                    setTimeout(() => {
                        emailjs.send(SERVICE_ID, TEMPLATE_ID, params).then(() => console.log(`Sent to ${row.name}`));
                    }, idx * 600);
                    count++;
                }
            });

            setTimeout(() => {
                el.style.display = 'none';
                showStatus(`✅ Processed! Emails sending to ${count} teachers.`);
            }, 2000);
        }

        function showStatus(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        function factoryReset() {
            if(confirm("WARNING: This will delete ALL cloud data!")) {
                database.ref('/').remove()
                    .then(() => { showStatus("♻️ Reset Complete"); updateStorageStatus(); })
                    .catch(e => showStatus("Error: " + e.message));
            }
        }
    </script>
</body>
</html>