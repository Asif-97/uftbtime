<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Controller Dashboard | UFTB Exam Controller</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #003366;
            --secondary-color: #f39c12;
            --sidebar-width: 250px;
            --bg-color: #f4f6f9;
            --text-color: #333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            display: flex;
            height: 100vh;
            color: var(--text-color);
        }

        /* Sidebar Styling */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .sidebar h3 {
            text-align: center;
            margin-bottom: 30px;
            font-weight: 600;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 15px;
        }

        .menu-item {
            padding: 12px 15px;
            color: #b8c7ce;
            text-decoration: none;
            border-radius: 4px;
            margin-bottom: 5px;
            transition: 0.3s;
            display: block;
        }

        .menu-item:hover, .menu-item.active {
            background-color: rgba(255,255,255,0.1);
            color: white;
            border-left: 4px solid var(--secondary-color);
        }

        .mt-auto { margin-top: auto; }

        /* Main Content Styling */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Header Styling */
        header {
            background: white;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .university-branding {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .university-branding img { height: 50px; }
        .university-branding h2 { font-size: 1.2rem; color: var(--primary-color); font-weight: 600; }

        /* NOTICE BOARD */
        .notice-board {
            background-color: #fff3cd;
            color: #856404;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #ffeeba;
        }
        .notice-label {
            font-weight: bold;
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            margin-right: 15px;
            font-size: 0.8rem;
            white-space: nowrap;
        }
        marquee { font-size: 0.95rem; font-weight: 500; }

        /* Dashboard Body */
        .dashboard-body {
            padding: 30px;
            overflow-y: auto;
            height: 100%;
        }

        .card-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: relative;
        }

        /* Full Screen Button */
        .fullscreen-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1.2rem;
            transition: 0.3s;
        }
        .fullscreen-btn:hover { color: var(--primary-color); transform: scale(1.1); }

        /* EXAM DETAILS INPUTS */
        .exam-inputs {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        
        .input-group label {
            display: block;
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
        }

        .input-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .input-group input:focus { outline: none; border-color: var(--secondary-color); }
        .input-group input:disabled { background-color: #e9ecef; cursor: not-allowed; }

        /* Timer Styles */
        .timer-display {
            font-size: 6rem; /* Increased size */
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
            color: var(--primary-color);
            text-align: center;
            margin: 20px 0;
            background: #fff;
            border: 2px solid #eee;
            border-radius: 10px;
            padding: 30px 20px;
        }

        .alert-mode {
            color: #e67e22 !important; 
            animation: pulse 1s infinite;
            border-color: #e67e22;
        }

        .critical-mode {
            color: #e74c3c !important; 
            animation: blinkFast 0.5s infinite;
            border-color: #e74c3c;
            background-color: #fadbd8;
        }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        @keyframes blinkFast { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        .controls { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
        }

        .btn-mid { background-color: #3498db; color: white; }
        .btn-mid:hover { background-color: #2980b9; }

        .btn-final { background-color: #9b59b6; color: white; }
        .btn-final:hover { background-color: #8e44ad; }
        
        .btn-custom { background-color: #2ecc71; color: white; } /* NEW Button Style */
        .btn-custom:hover { background-color: #27ae60; }

        .btn-reset { background-color: #e74c3c; color: white; }
        .btn-reset:hover { background-color: #c0392b; }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            background: #eee;
            color: #666;
        }
        
        .info-list li { margin-bottom: 10px; list-style: none; position: relative; padding-left: 20px; color: #555; font-size: 0.9rem;}
        .info-list li::before { content: 'â€¢'; color: var(--primary-color); font-weight: bold; position: absolute; left: 0; }

        .mute-control {
            margin-top: 15px;
            font-size: 0.8rem;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        /* Full Screen Specific Adjustments */
        body.fullscreen-mode .sidebar, 
        body.fullscreen-mode header { display: none; }
        
        body.fullscreen-mode .main-content { height: 100vh; background: white; }
        body.fullscreen-mode .dashboard-body { padding: 0; display: flex; align-items: center; justify-content: center; }
        body.fullscreen-mode .card-container { display: flex; width: 90%; max-width: 1000px; }
        body.fullscreen-mode .card:last-child { display: none; } /* Hide info card in fullscreen */
        body.fullscreen-mode .card:first-child { width: 100%; border: none; box-shadow: none; }
        body.fullscreen-mode .timer-display { font-size: 12rem; border: none; margin: 0; }
        body.fullscreen-mode .fullscreen-btn { top: 30px; right: 30px; font-size: 2rem; }
    </style>
</head>
<body>

  <aside class="sidebar">
    <h3>UFTB HUB</h3>
    <a href="index.html" class="menu-item active">Exam Dashboard</a>
    <a href="schedule.html" class="menu-item">Schedule</a>
    <a href="invigilators.html" class="menu-item">Invigilators</a>
    <a href="settings.html" class="menu-item">Settings</a>
    
    <a href="https://uftb.ac.bd/" target="_blank" class="menu-item mt-auto">Go to UFTB Website</a>
</aside>

    <div class="main-content" id="mainArea">
        <header>
            <div class="university-branding">
                <img src="https://uftb.ac.bd/uploads/settings/17663114198452.png" alt="UFTB Logo">
                <h2>University of Frontier Technology, Bangladesh</h2>
            </div>
            <div>
                <span class="status-badge" id="exam-status">No Exam Active</span>
            </div>
        </header>

        <div class="notice-board">
            <span class="notice-label">NOTICE BOARD</span>
            <marquee behavior="scroll" direction="left">
                Keep your ID card on the desk. No mobile phones or smartwatches allowed inside the exam hall. Do not talk to other students. Stop writing immediately when the time is up.
            </marquee>
        </div>

        <div class="dashboard-body">
            <div class="card-container">
                <div class="card">
                    <button class="fullscreen-btn" onclick="toggleFullScreen()" title="Toggle Full Screen">
                        <i class="fas fa-expand"></i>
                    </button>

                    <div class="exam-inputs">
                        <div class="input-group">
                            <label>Course Code</label>
                            <input type="text" id="courseCode" placeholder="e.g. CSE-401" oninput="saveInputs()">
                        </div>
                        <div class="input-group">
                            <label>Course Title</label>
                            <input type="text" id="courseTitle" placeholder="e.g. Artificial Intelligence" oninput="saveInputs()">
                        </div>
                    </div>

                    <div class="timer-display" id="display">00:00:00</div>

                    <div class="controls">
                        <button class="btn-mid" onclick="startExam('mid')">Mid-Term (2H)</button>
                        <button class="btn-final" onclick="startExam('final')">Final (3H)</button>
                        <button class="btn-custom" onclick="startCustomExam()">Custom Time</button>
                        <button class="btn-reset" onclick="resetTimer()">Reset</button>
                    </div>
                    
                    <div class="mute-control">
                        <input type="checkbox" id="voiceEnabled" checked> 
                        <label for="voiceEnabled">Enable Voice Alerts</label>
                    </div>
                </div>

                <div class="card">
                    <h4 style="margin-bottom: 15px; color: var(--primary-color);">Exam Instructions</h4>
                    <ul class="info-list">
                        <li><strong>Mid-Term:</strong> 2 Hours.</li>
                        <li><strong>Final Exam:</strong> 3 Hours.</li>
                        <li><strong>Custom:</strong> Set any duration for Quizzes/Labs.</li>
                        <li><strong>Alerts:</strong> Half-time (Orange) & Last 5 min (Red).</li>
                    </ul>
                    <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">
                    <div style="text-align: center;">
                        <p style="font-size: 0.8rem; color: #888;">System Date:</p>
                        <p id="current-date" style="font-weight: bold; color: var(--primary-color);">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let countdown;
        let halfTimeTriggered = false; 
        let fiveMinTriggered = false;
        let voices = [];

        // Setup Date
        const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        document.getElementById('current-date').innerText = new Date().toLocaleDateString('en-US', dateOptions);

        // Load Voices
        window.speechSynthesis.onvoiceschanged = function() {
            voices = window.speechSynthesis.getVoices();
        };

        window.onload = function() {
            window.speechSynthesis.getVoices(); // Init voices

            // Restore Inputs
            if(localStorage.getItem('courseCode')) document.getElementById('courseCode').value = localStorage.getItem('courseCode');
            if(localStorage.getItem('courseTitle')) document.getElementById('courseTitle').value = localStorage.getItem('courseTitle');

            // Restore Timer
            const savedTargetTime = localStorage.getItem('targetTime');
            const savedExamType = localStorage.getItem('examType');
            const savedDuration = localStorage.getItem('customDuration'); // New for custom

            if (savedTargetTime && savedExamType) {
                const now = new Date().getTime();
                if (savedTargetTime > now) {
                    lockInputs();
                    // Need to pass duration to calculate half-time correctly
                    let duration = savedDuration ? parseInt(savedDuration) : 0;
                    if(savedExamType === 'mid') duration = 2 * 60 * 60;
                    if(savedExamType === 'final') duration = 3 * 60 * 60;
                    
                    runTimer(savedExamType, parseInt(savedTargetTime), duration);
                } else {
                    localStorage.clear();
                }
            }
        };

        function saveInputs() {
            localStorage.setItem('courseCode', document.getElementById('courseCode').value);
            localStorage.setItem('courseTitle', document.getElementById('courseTitle').value);
        }

        function lockInputs() {
            document.getElementById('courseCode').disabled = true;
            document.getElementById('courseTitle').disabled = true;
        }

        // --- NEW: Custom Exam Logic ---
        function startCustomExam() {
            let minutes = prompt("Enter exam duration in minutes (e.g., 45):");
            if (minutes == null || minutes == "") return;
            if (isNaN(minutes) || minutes <= 0) {
                alert("Please enter a valid number of minutes.");
                return;
            }
            
            // Convert to integer
            let durationSeconds = parseInt(minutes) * 60;
            startExam('custom', durationSeconds);
        }

        function startExam(type, customSeconds = 0) {
            const code = document.getElementById('courseCode').value;
            const title = document.getElementById('courseTitle').value;
            
            if(code === "" || title === "") {
                if(!confirm("Course details are empty. Start anyway?")) return;
            }

            let durationSeconds = 0;
            if (type === 'mid') durationSeconds = 2 * 60 * 60;
            else if (type === 'final') durationSeconds = 3 * 60 * 60;
            else if (type === 'custom') durationSeconds = customSeconds;

            // TEST: Uncomment to test logic quickly
            // durationSeconds = 20; 

            const now = new Date().getTime();
            const targetTime = now + (durationSeconds * 1000);

            localStorage.setItem('targetTime', targetTime);
            localStorage.setItem('examType', type);
            if(type === 'custom') localStorage.setItem('customDuration', durationSeconds);
            
            localStorage.setItem('halfTimeTriggered', 'false');
            localStorage.setItem('fiveMinTriggered', 'false');
            
            saveInputs();
            lockInputs();

            runTimer(type, targetTime, durationSeconds);
        }

        function runTimer(type, targetTime, totalDurationSeconds) {
            clearInterval(countdown);
            document.getElementById('display').classList.remove('alert-mode', 'critical-mode');
            
            halfTimeTriggered = localStorage.getItem('halfTimeTriggered') === 'true';
            fiveMinTriggered = localStorage.getItem('fiveMinTriggered') === 'true';

            let durationName = "";
            if(type === 'mid') durationName = "Mid-Term Exam";
            else if(type === 'final') durationName = "Final Exam";
            else durationName = "Exam"; // For custom

            // Dynamic Alert Logic
            let halfTimeSeconds = totalDurationSeconds / 2;
            let fiveMinSeconds = 5 * 60;

            // TEST:
            // halfTimeSeconds = 10;
            // fiveMinSeconds = 5;

            updateBadge(type, durationName);

            countdown = setInterval(() => {
                const now = new Date().getTime();
                const distance = targetTime - now;
                const secondsLeft = Math.floor(distance / 1000);

                if (distance < 0) {
                    clearInterval(countdown);
                    document.getElementById('display').innerText = "00:00:00";
                    finishExam(); 
                    return;
                }

                // 1. HALF TIME ALERT (Only if total duration > 10 mins to avoid spam in short tests)
                if (!halfTimeTriggered && totalDurationSeconds > 600 && secondsLeft <= halfTimeSeconds && secondsLeft > fiveMinSeconds) {
                    triggerHalfTimeWarning();
                    halfTimeTriggered = true;
                    localStorage.setItem('halfTimeTriggered', 'true');
                }

                // 2. LAST 5 MIN ALERT
                if (!fiveMinTriggered && secondsLeft <= fiveMinSeconds) {
                    triggerFiveMinWarning();
                    fiveMinTriggered = true;
                    localStorage.setItem('fiveMinTriggered', 'true');
                }

                updateDisplay(secondsLeft);
            }, 1000);
        }

        function updateDisplay(secondsLeft) {
            const hours = Math.floor(secondsLeft / 3600);
            const minutes = Math.floor((secondsLeft % 3600) / 60);
            const seconds = secondsLeft % 60;
            document.getElementById('display').innerText = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;
        }

        // --- ALERTS ---
        function triggerHalfTimeWarning() {
            document.getElementById('display').classList.add('alert-mode'); 
            speakText("Attention please. Half of the exam duration is over.");
        }

        function triggerFiveMinWarning() {
            document.getElementById('display').classList.remove('alert-mode'); 
            document.getElementById('display').classList.add('critical-mode');
            speakText("Attention students. Last five minutes remaining. Please check your identification number properly.");
        }

        function finishExam() {
            document.getElementById('display').classList.remove('critical-mode');
            const badge = document.getElementById('exam-status');
            badge.innerText = "Exam Finished";
            badge.style.background = "#e74c3c";
            
            const finalMessage = "Time is up. Please stop writing immediately and submit your answer scripts.";

            if(document.getElementById('voiceEnabled').checked) {
                speakText(finalMessage);
                setTimeout(() => speakText(finalMessage), 5000);
                setTimeout(() => speakText(finalMessage), 10000);
            }

            localStorage.clear(); 
        }

        // --- NEW: FULL SCREEN LOGIC ---
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                document.body.classList.add('fullscreen-mode');
                document.querySelector('.fullscreen-btn i').classList.remove('fa-expand');
                document.querySelector('.fullscreen-btn i').classList.add('fa-compress');
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    document.body.classList.remove('fullscreen-mode');
                    document.querySelector('.fullscreen-btn i').classList.add('fa-expand');
                    document.querySelector('.fullscreen-btn i').classList.remove('fa-compress');
                }
            }
        }

        // Listen for Escape key to exit fullscreen style properly
        document.addEventListener('fullscreenchange', (event) => {
            if (!document.fullscreenElement) {
                document.body.classList.remove('fullscreen-mode');
                document.querySelector('.fullscreen-btn i').classList.add('fa-expand');
            }
        });

        // --- HELPERS ---
        function speakText(text) {
            if(!document.getElementById('voiceEnabled').checked) return;

            const utterance = new SpeechSynthesisUtterance(text);
            voices = window.speechSynthesis.getVoices();
            const preferredVoice = voices.find(voice => 
                voice.name.includes("Google US English") || 
                voice.name.includes("Zira") || 
                voice.name.includes("Female")
            );

            if (preferredVoice) utterance.voice = preferredVoice;
            utterance.rate = 0.85; 
            window.speechSynthesis.speak(utterance);
        }

        function updateBadge(type, name) {
            const badge = document.getElementById('exam-status');
            badge.innerText = `${name} Running`;
            
            if (type === 'mid') badge.style.background = "#3498db";
            else if (type === 'final') badge.style.background = "#9b59b6";
            else badge.style.background = "#2ecc71"; // Green for Custom

            badge.style.color = "white";
        }

        function resetTimer() {
            if(!confirm("Are you sure you want to reset the exam timer?")) return;
            clearInterval(countdown);
            localStorage.clear(); 
            location.reload(); 
        }

        function pad(val) { return val < 10 ? '0' + val : val; }
    </script>
</body>
</html>