<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | UFTB</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
   
    <style>
        :root { --primary: #003366; --primary-dark: #002244; --accent: #f39c12; --light: #f4f7f6; --white: #ffffff; --danger: #e74c3c; --success: #2ecc71; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background: var(--light); display: flex; height: 100vh; overflow: hidden; color: #2c3e50; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOutUp { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-50px); } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); } 100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); } }
        .animate-up { animation: fadeIn 0.6s ease-out forwards; }

        .sidebar { width: 260px; background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%); color: white; padding: 25px; display: flex; flex-direction: column; box-shadow: 4px 0 15px rgba(0,0,0,0.1); z-index: 100; }
        .sidebar-header { text-align: center; margin-bottom: 40px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px; }
        .menu-item { display: flex; align-items: center; padding: 12px 20px; color: rgba(255,255,255,0.8); text-decoration: none; border-radius: 10px; margin-bottom: 8px; transition: 0.3s; font-size: 0.95rem; margin-right: 5px; }
        .menu-item i { margin-right: 15px; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.2); color: white; transform: translateX(5px); }
        .mt-auto { margin-top: auto; }

        .main-content { flex: 1; display: flex; flex-direction: column; overflow-y: auto; position: relative; }
       
        header { background: var(--white); height: 90px; display: flex; align-items: center; justify-content: space-between; padding: 0 40px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 50; }
        .brand-area { display: flex; align-items: center; }
        .brand-area img { height: 55px; margin-right: 15px; }
        .brand-area h2 { font-size: 1.4rem; color: var(--primary); font-weight: 700; letter-spacing: 0.5px; }
        
        /* CLICKABLE CLOCK CSS */
        .live-clock { font-family: 'Courier New', monospace; font-weight: 700; font-size: 1.2rem; color: var(--primary); background: #eef2f7; padding: 8px 15px; border-radius: 8px; border: 1px solid #dce4ec; cursor: pointer; transition: 0.3s; }
        .live-clock:hover { background: var(--primary); color: white; transform: translateY(-2px); box-shadow: 0 5px 10px rgba(0,0,0,0.1); }

        .notice-bar { background: #fff8e1; color: #d35400; border-bottom: 1px solid #ffe0b2; display: flex; align-items: center; padding: 0 20px; height: 40px; font-size: 0.9rem; font-weight: 600; display: none; }
        .notice-label { background: var(--danger); color: white; padding: 2px 10px; border-radius: 4px; font-size: 0.75rem; margin-right: 15px; text-transform: uppercase; font-weight: 700; letter-spacing: 1px; flex-shrink: 0; }
        marquee { width: 100%; display: flex; align-items: center; margin-top: 3px; }
        .notice-item { margin-right: 50px; display: inline-flex; align-items: center; }
        .notice-item i { margin-right: 8px; }

        .central-notice-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); z-index: 200; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .big-notice-card { background: white; width: 60%; max-width: 800px; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); text-align: center; border-top: 8px solid var(--danger); animation: fadeIn 0.5s ease-out; }
        .big-notice-card h2 { color: var(--danger); font-size: 2rem; margin-bottom: 20px; display: flex; justify-content: center; align-items: center; }
        .big-notice-card h2 i { margin-right: 15px; }
        .big-rules-list { text-align: left; margin: 0 auto; max-width: 600px; list-style: none; }
        .big-rules-list li { padding: 15px; border-bottom: 1px solid #eee; font-size: 1.1rem; color: #444; display: flex; align-items: center; }
        .big-rules-list li i { color: var(--danger); font-size: 1.3rem; margin-right: 15px; }
        .minimize-btn { margin-top: 30px; padding: 15px 40px; background: var(--primary); color: white; border: none; border-radius: 50px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: 0.3s; display: inline-flex; align-items: center; }
        .minimize-btn i { margin-left: 10px; }
        .minimize-btn:hover { background: var(--accent); transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }

        .dashboard-body { padding: 30px 40px; display: flex; flex-direction: column; flex: 1; justify-content: center; opacity: 0.3; transition: 0.5s; }
        .exam-card { background: white; border-radius: 20px; padding: 40px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.05); position: relative; margin-bottom: auto; margin-top: auto; }
       
        .timer-wrapper { margin: 20px 0; }
        .timer-display { font-size: 90px; font-size: clamp(4rem, 10vw, 8rem); font-weight: 700; color: var(--primary); font-family: 'Courier New', monospace; line-height: 1; letter-spacing: -3px; }
        .status-text { font-size: 1.3rem; color: var(--accent); font-weight: 600; min-height: 30px; }
       
        .tools-grid { display: flex; justify-content: center; margin-bottom: 30px; }
        .tool-box { background: #f8f9fa; padding: 10px 20px; border-radius: 50px; border: 1px solid #eee; display: flex; align-items: center; flex-wrap: wrap; justify-content: center; }
        .tool-box > * { margin: 0 5px; }
        .tool-label { font-weight: 600; color: #555; font-size: 0.9rem; }
       
        .custom-input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; outline: none; font-family: 'Poppins', sans-serif; font-weight: 600; color: var(--primary); }
        .type-select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; outline: none; font-family: 'Poppins', sans-serif; font-weight: 600; color: #555; cursor: pointer; }
        .btn-arm { background: var(--accent); color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        .btn-arm:hover { background: #d35400; }

        .control-panel { margin-top: 30px; display: flex; justify-content: center; flex-wrap: wrap; }
        .main-btn { padding: 15px 40px; margin: 10px; border: none; border-radius: 50px; font-weight: 600; font-size: 1.1rem; cursor: pointer; transition: 0.3s; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: flex; align-items: center; }
        .main-btn i { margin-right: 10px; }
        .btn-mid { background: #3498db; } .btn-final { background: #9b59b6; } .btn-quiz { background: var(--success); } .btn-reset { background: var(--danger); }
        .waiting-mode { animation: pulse-red 2s infinite; border: 2px solid var(--accent); }

        .dashboard-footer { margin-top: 30px; display: flex; justify-content: flex-end; padding-bottom: 10px; transition: 0.5s; }
        .signature-box { text-align: center; width: 250px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .signature-title { font-weight: 700; font-size: 1.1rem; text-transform: uppercase; letter-spacing: 1.5px; color: var(--primary); }
        .signature-line { height: 3px; width: 100%; background: #8fa0b5; margin: 8px 0; border-radius: 5px; }
        .designation { font-size: 0.9rem; font-style: italic; color: #2c3e50; font-weight: 500; line-height: 1.4; }

        .fullscreen-btn { position: absolute; top: 30px; right: 30px; font-size: 1.5rem; color: #ccc; cursor: pointer; border: none; background: none; transition: 0.3s; }
        .fullscreen-btn:hover { color: var(--primary); transform: scale(1.1); }

        body.fullscreen-mode .sidebar, body.fullscreen-mode .notice-bar, body.fullscreen-mode .tools-grid, body.fullscreen-mode .control-panel, body.fullscreen-mode .status-text { display: none !important; }
        body.fullscreen-mode .main-content { padding: 0; background: white; }
        body.fullscreen-mode .exam-card { box-shadow: none; border-radius: 0; height: 100vh; width: 100%; margin: 0; padding: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        body.fullscreen-mode .timer-wrapper { width: 100%; display: flex; justify-content: center; align-items: center; }
        body.fullscreen-mode .timer-display { font-size: 150px; font-size: 17vw; margin: 0; line-height: 1; text-align: center; }
        body.fullscreen-mode header { padding: 0 50px; height: 100px; border-bottom: 2px solid #f0f0f0; }

        body.fullscreen-mode .dashboard-footer { position: fixed; bottom: 25px; right: 35px; display: block !important; z-index: 1000; margin: 0; padding: 0; opacity: 0.8; }
        body.fullscreen-mode .signature-box { text-align: center; width: 250px; align-items: center; }
        body.fullscreen-mode .signature-line { margin: 8px 0; }

        /* ================= BIG FULLSCREEN CLOCK (EXACT WHITE DESIGN) ================= */
        .clock-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999;
            flex-direction: column; justify-content: center; align-items: center;
            animation: fadeIn 0.3s ease-out;
        }
        .clock-overlay.active { display: flex; }
        .big-clock-time {
            font-size: 14vw; font-weight: 700; font-family: 'Courier New', monospace;
            letter-spacing: -3px; line-height: 1; color: var(--primary); 
            white-space: nowrap; /* Tader jeno na vange */
        }
        .big-clock-date { font-size: 2vw; margin-top: 15px; font-weight: 600; color: #7f8c8d; letter-spacing: 2px; font-family: 'Poppins', sans-serif;}
        
        .overlay-header {
            position: absolute; top: 0; left: 0; width: 100%; height: 100px;
            padding: 0 50px; border-bottom: 2px solid #f0f0f0;
            display: flex; align-items: center; justify-content: space-between;
            background: white;
        }
        .overlay-footer { position: absolute; bottom: 25px; right: 35px; opacity: 0.8; }
        
        .close-clock-btn { font-size: 1.5rem; color: #ccc; background: none; border: none; cursor: pointer; transition: 0.3s; }
        .close-clock-btn:hover { color: var(--primary); transform: scale(1.1); }

        @media (max-width: 768px) { 
            .brand-area h2 { font-size: 1rem; } 
            .timer-display { font-size: 60px; } 
            .big-clock-time { font-size: 16vw; } 
            .big-clock-date { font-size: 4vw; } 
            .overlay-header { padding: 0 20px; } 
        }
    </style>
</head>
<body>

    <div class="clock-overlay" id="clockOverlay">
        <div class="overlay-header">
            <div class="brand-area">
                <img src="logo.png" alt="UFTB Logo" onerror="this.onerror=null; this.src='https://cdn-icons-png.flaticon.com/512/3003/3003058.png';">
                <h2>University of Frontier Technology, Bangladesh</h2>
            </div>
            <button class="close-clock-btn" onclick="closeBigClock()"><i class="fas fa-compress"></i></button>
        </div>

        <div class="big-clock-time" id="bigClockTime">00:00:00</div>
        <div class="big-clock-date" id="bigClockDate">Loading...</div>

        <div class="overlay-footer">
            <div class="signature-box">
                <div class="signature-title">Developed By</div>
                <div class="signature-line"></div>
                <div class="designation">Md Asif Sarkar</div>
                 <div class="designation">Department of EdTE</div>
                 <div class="designation">Session: 2021-22</div>
            </div>
        </div>
    </div>

    <aside class="sidebar">
        <div class="sidebar-header">
            <h3>UFTB </h3>
            <p style="font-size: 0.8rem; opacity: 0.7;">Exam Control System</p>
        </div>
        <nav>
            <a href="index.html" class="menu-item active"><i class="fas fa-clock"></i> Dashboard</a>
            <a href="schedule.html" class="menu-item"><i class="fas fa-calendar-alt"></i> Exam Schedule</a>
            <a href="invigilators.html" class="menu-item"><i class="fas fa-users"></i> Invigilators</a>
            <a href="settings.html" class="menu-item"><i class="fas fa-user-shield"></i> Admin Panel</a>
        </nav>
        <a href="#" class="menu-item mt-auto" onclick="resetSystem()"><i class="fas fa-sync"></i> Reset System</a>
    </aside>

    <div class="main-content">
        <header>
            <div class="brand-area">
                <img src="logo.png" alt="UFTB Logo" onerror="this.onerror=null; this.src='https://cdn-icons-png.flaticon.com/512/3003/3003058.png';">
                <h2>University of Frontier Technology, Bangladesh</h2>
            </div>
            <div class="live-clock" id="liveClock" onclick="openBigClock()" title="Click to view full screen clock">Connecting...</div>
        </header>

        <div class="notice-bar" id="topNoticeBar">
            <span class="notice-label">ATTENTION</span>
            <marquee onmouseover="this.stop()" onmouseout="this.start()">
                <span class="notice-item"><i class="fas fa-mobile-alt"></i> Mobile phones, smartwatches, and digital devices are strictly prohibited.</span>
                <span class="notice-item"><i class="fas fa-id-card"></i> Keep your Admit Card visible.</span>
                <span class="notice-item"><i class="fas fa-door-open"></i> No leaving before half-time.</span>
            </marquee>
        </div>

        <div class="central-notice-overlay" id="centralNotice">
            <div class="big-notice-card">
                <h2><i class="fas fa-exclamation-circle"></i> Examination Hall Rules</h2>
                <ul class="big-rules-list">
                    <li><i class="fas fa-mobile-alt"></i> No mobile phones or smartwatches allowed.</li>
                    <li><i class="fas fa-comments"></i> Strictly no talking or communicating.</li>
                    <li><i class="fas fa-book-dead"></i> No unauthorized books, notes, or papers.</li>
                    <li><i class="fas fa-id-badge"></i> Keep Student ID & Admit Card on the desk.</li>
                </ul>
                <button class="minimize-btn" onclick="minimizeNotice()">
                    Minimize to Dashboard <i class="fas fa-compress-arrows-alt"></i>
                </button>
            </div>
        </div>

        <div class="dashboard-body" id="mainDashboard">
            <div class="exam-card animate-up">
                <button class="fullscreen-btn" onclick="toggleFullScreen()"><i class="fas fa-expand"></i></button>
                <div class="status-text" id="statusMsg">Ready for Exam</div>
               
                <div class="timer-wrapper">
                    <div class="timer-display" id="display">00:00:00</div>
                </div>

                <div class="tools-grid">
                    <div class="tool-box">
                        <div class="tool-label"><i class="fas fa-history"></i> Schedule:</div>
                        <input type="time" id="scheduleInput" class="custom-input">
                       
                        <select id="scheduleType" class="type-select">
                            <option value="mid">Mid Term</option>
                            <option value="final">Final Exam</option>
                            <option value="ct">CT / Quiz</option>
                        </select>

                        <button class="btn-arm" onclick="setSchedule()">Set Timer</button>
                    </div>
                </div>

                <div class="control-panel">
                    <button class="main-btn btn-mid" onclick="startExam(7200, 'Mid-Term Exam')"><i class="fas fa-hourglass-half"></i> Mid Term (2H)</button>
                    <button class="main-btn btn-final" onclick="startExam(10800, 'Final Exam')"><i class="fas fa-hourglass-end"></i> Final Exam (3H)</button>
                    <button class="main-btn btn-quiz" onclick="startQuizFlow()"><i class="fas fa-stopwatch"></i> CT / Quiz</button>
                    <button class="main-btn btn-reset" onclick="resetSystem()"><i class="fas fa-redo"></i> Reset</button>
                </div>
            </div>

            <div class="dashboard-footer animate-up" style="animation-delay: 0.3s;">
                <div class="signature-box">
                    <div class="signature-title">Developed By</div>
                    <div class="signature-line"></div>
                    <div class="designation">Md Asif Sarkar</div>
                     <div class="designation">Department of EdTE</div>
                     <div class="designation">Session: 2021-22</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var baseInternetTime = null; 
        var basePerfTime = null;     
        
        function getSafePerfTime() {
            return (window.performance && window.performance.now) ? window.performance.now() : Date.now();
        }

        async function fetchNetworkTime() {
            try {
                document.getElementById('liveClock').innerText = "Syncing...";
                let response = await fetch('https://worldtimeapi.org/api/timezone/Asia/Dhaka');
                let data = await response.json();
                
                baseInternetTime = data.unixtime * 1000; 
                basePerfTime = getSafePerfTime();
            } catch (error) {
                console.warn("Time API failed. Using offline device time.");
            }
        }

        function getRealTime() {
            if (!baseInternetTime || !basePerfTime) return Date.now();
            return baseInternetTime + (getSafePerfTime() - basePerfTime);
        }

        function getDhakaDate() {
            var ms = getRealTime();
            var d = new Date(ms);
            var utc = d.getTime() + (d.getTimezoneOffset() * 60000);
            return new Date(utc + (3600000 * 6)); 
        }

        window.onload = async function() {
            await fetchNetworkTime(); 

            var savedEndTime = localStorage.getItem('activeExamEnd');
            var savedTitle = localStorage.getItem('activeExamTitle');
            var savedDuration = localStorage.getItem('activeExamDuration');

            if (savedEndTime && savedDuration) {
                document.getElementById('centralNotice').style.display = 'none';
                document.getElementById('topNoticeBar').style.display = 'flex';
                document.getElementById('mainDashboard').style.opacity = '1';

                var now = getRealTime();
                if (parseInt(savedEndTime) > now) {
                    launchTimer(parseInt(savedEndTime), savedTitle, parseInt(savedDuration));
                } else {
                    document.getElementById('display').innerText = "00:00:00";
                    document.getElementById('statusMsg').innerText = "Time Up (Expired)";
                    document.getElementById('statusMsg').style.color = "#e74c3c";
                    localStorage.removeItem('activeExamEnd');
                    localStorage.removeItem('activeExamDuration');
                }
            }

            var savedSchedTime = localStorage.getItem('schedTime');
            if (savedSchedTime) {
                document.getElementById('scheduleInput').value = savedSchedTime;
                setSchedule(true);
            }
        };

        function minimizeNotice() {
            var overlay = document.getElementById('centralNotice');
            var dashboard = document.getElementById('mainDashboard');
            var topBar = document.getElementById('topNoticeBar');
            overlay.style.animation = "fadeOutUp 0.5s ease forwards";
            setTimeout(function() {
                overlay.style.display = 'none';
                topBar.style.display = 'flex';
                dashboard.style.opacity = '1';
            }, 500);
        }

        // ================= FULLSCREEN BIG CLOCK LOGIC =================
        function openBigClock() {
            var overlay = document.getElementById('clockOverlay');
            overlay.classList.add('active');
            
            var elem = document.documentElement;
            if (elem.requestFullscreen) { elem.requestFullscreen(); } 
            else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen(); } 
            else if (elem.mozRequestFullScreen) { elem.mozRequestFullScreen(); } 
            else if (elem.msRequestFullscreen) { elem.msRequestFullscreen(); }
        }

        function closeBigClock() {
            var overlay = document.getElementById('clockOverlay');
            overlay.classList.remove('active');
            
            if (document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement) {
                if (document.exitFullscreen) { document.exitFullscreen(); } 
                else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); } 
                else if (document.mozCancelFullScreen) { document.mozCancelFullScreen(); } 
                else if (document.msExitFullscreen) { document.msExitFullscreen(); }
            }
        }

        function updateClock() {
            var dhakaDate = getDhakaDate();
            
            var h = dhakaDate.getHours();
            var m = dhakaDate.getMinutes();
            var s = dhakaDate.getSeconds();
            var ampm = h >= 12 ? 'PM' : 'AM';
            
            var h12 = h % 12;
            h12 = h12 ? h12 : 12; 
            
            var timeString = pad(h12) + ':' + pad(m) + ':' + pad(s) + ' ' + ampm;
            
            var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            var dateString = days[dhakaDate.getDay()] + ", " + months[dhakaDate.getMonth()] + " " + dhakaDate.getDate() + ", " + dhakaDate.getFullYear();
            
            document.getElementById('liveClock').innerText = timeString;
            document.getElementById('bigClockTime').innerText = timeString;
            document.getElementById('bigClockDate').innerText = dateString;

            checkSchedule(dhakaDate);
        }
        setInterval(updateClock, 1000);

        var voices = [];
        function loadVoices() { voices = window.speechSynthesis.getVoices(); }
        if (window.speechSynthesis && window.speechSynthesis.onvoiceschanged !== undefined) {
            window.speechSynthesis.onvoiceschanged = loadVoices;
        }

        function speak(text, repeatCount) {
            if(!repeatCount) repeatCount = 1;
            if(!window.speechSynthesis) return; 
            
            var count = 0;
            function playVoice() {
                if (count >= repeatCount) return;
                var utterance = new SpeechSynthesisUtterance(text);
                
                var maleVoice = null;
                for(var i=0; i<voices.length; i++){
                    var vName = voices[i].name.toLowerCase();
                    if(vName.indexOf('male') > -1 || vName.indexOf('guy') > -1 || vName.indexOf('david') > -1 || vName.indexOf('mark') > -1 || vName.indexOf('daniel') > -1){
                        maleVoice = voices[i];
                        break;
                    }
                }
                
                if (maleVoice) { utterance.voice = maleVoice; } 
                else { utterance.pitch = 0.5; }
                
                utterance.rate = 0.9;
                utterance.onend = function() {
                    count++;
                    if (count < repeatCount) { setTimeout(playVoice, 500); }
                };
                window.speechSynthesis.speak(utterance);
            }
            playVoice();
        }

        var timerInterval;
        var scheduledTime = null;
        var scheduledDuration = 0;
        var scheduledTitle = "";

        function setSchedule(isRestore) {
            var timeInput = document.getElementById('scheduleInput').value;
            var typeInput = document.getElementById('scheduleType').value;

            if(!timeInput && !isRestore) return alert("Please select a time first!");

            localStorage.setItem('schedTime', timeInput);
            localStorage.setItem('schedType', typeInput);

            if(typeInput === 'mid') { scheduledDuration = 7200; scheduledTitle = "Mid-Term Exam"; }
            else if(typeInput === 'final') { scheduledDuration = 10800; scheduledTitle = "Final Exam"; }
            else if(typeInput === 'ct') {
                if(!isRestore) {
                    var mins = prompt("Enter CT Duration (min):", "15");
                    if (!mins || isNaN(mins)) return;
                    scheduledDuration = mins * 60;
                } else {
                    scheduledDuration = 900; 
                }
                scheduledTitle = "Class Test";
            }

            scheduledTime = timeInput;
            document.getElementById('statusMsg').innerText = "Waiting for " + scheduledTitle + " at " + convertTo12Hour(timeInput) + "...";
            document.getElementById('statusMsg').style.color = "#f39c12";
            document.querySelector('.exam-card').classList.add('waiting-mode');
            document.getElementById('scheduleInput').disabled = true;
            document.getElementById('scheduleType').disabled = true;
        }

        function checkSchedule(dhakaDate) {
            if(!scheduledTime) return;
            
            var currentH = pad(dhakaDate.getHours());
            var currentM = pad(dhakaDate.getMinutes());
            var currentS = dhakaDate.getSeconds();

            if (currentH + ":" + currentM === scheduledTime && currentS === 0) {
                scheduledTime = null;
                localStorage.removeItem('schedTime'); 
                document.querySelector('.exam-card').classList.remove('waiting-mode');
                startExam(scheduledDuration, scheduledTitle);
            }
        }

        function startQuizFlow() {
            var minutes = prompt("Enter Quiz Duration (in minutes):", "15");
            if (minutes && !isNaN(minutes) && minutes > 0) startExam(minutes * 60, "Class Test");
        }

        function startExam(durationSeconds, title) {
            var endTime = getRealTime() + (durationSeconds * 1000);
            localStorage.setItem('activeExamEnd', endTime);
            localStorage.setItem('activeExamTitle', title);
            localStorage.setItem('activeExamDuration', durationSeconds);
            launchTimer(endTime, title, durationSeconds);
        }

        function launchTimer(endTime, title, totalDurationSeconds) {
            clearInterval(timerInterval);
            document.getElementById('statusMsg').innerText = title + " in Progress";
            document.getElementById('statusMsg').style.color = "#2ecc71";
           
            var initialDiff = Math.round((endTime - getRealTime()) / 1000);
            
            var startAnnounced = (initialDiff < totalDurationSeconds - 2); 
            var halfTimeAnnounced = (initialDiff <= totalDurationSeconds / 2);
            var last5MinAnnounced = (initialDiff <= 300);
            var finishAnnounced = false;

            if (!startAnnounced) {
                speak("Attention please. The " + title + " has started.", 1);
                startAnnounced = true;
            }

            timerInterval = setInterval(function() {
                var now = getRealTime();
                var diff = Math.round((endTime - now) / 1000);

                if (diff <= (totalDurationSeconds / 2) && !halfTimeAnnounced && diff > 0) {
                    speak("Attention please. Half time is over.", 1);
                    halfTimeAnnounced = true;
                }

                if (diff <= 300 && !last5MinAnnounced && diff > 0) {
                    speak("Attention please. Only 5 minutes remaining.", 1);
                    last5MinAnnounced = true;
                }

                if (diff <= 0) {
                    clearInterval(timerInterval);
                    document.getElementById('display').innerText = "00:00:00";
                    document.getElementById('statusMsg').innerText = "Time Up!";
                    document.getElementById('statusMsg').style.color = "#e74c3c";
                    
                    if (!finishAnnounced) {
                        speak("Time is up. Please stop writing.", 3);
                        finishAnnounced = true;
                    }
                    
                    localStorage.removeItem('activeExamEnd'); 
                    localStorage.removeItem('activeExamDuration'); 
                    return;
                }

                var h = Math.floor(diff / 3600);
                var m = Math.floor((diff % 3600) / 60);
                var s = diff % 60;
                document.getElementById('display').innerText = pad(h) + ":" + pad(m) + ":" + pad(s);
            }, 1000);
        }

        function resetSystem() {
            if(confirm("Stop timer and reset?")) {
                localStorage.clear();
                location.reload();
            }
        }

        function toggleFullScreen() {
            var elem = document.documentElement;
            var isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;

            if (!isFullscreen) {
                if (elem.requestFullscreen) { elem.requestFullscreen(); } 
                else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen(); } 
                else if (elem.mozRequestFullScreen) { elem.mozRequestFullScreen(); } 
                else if (elem.msRequestFullscreen) { elem.msRequestFullscreen(); }
                document.body.classList.add('fullscreen-mode');
            } else {
                if (document.exitFullscreen) { document.exitFullscreen(); } 
                else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); } 
                else if (document.mozCancelFullScreen) { document.mozCancelFullScreen(); } 
                else if (document.msExitFullscreen) { document.msExitFullscreen(); }
                document.body.classList.remove('fullscreen-mode');
            }
        }

        function pad(n) { return n < 10 ? '0' + n : n; }
        function convertTo12Hour(t) { 
            var parts = t.split(':'); 
            var h = parseInt(parts[0]);
            var m = parts[1];
            var ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12;
            h = h ? h : 12;
            return h + ":" + m + " " + ampm; 
        }
    </script>
</body>
</html>